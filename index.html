<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LRID™ Assessment</title>
  <style>
    :root{--bg:#f6f7fb;--card:#fff;--border:#e6e7ee;--text:#111;--muted:#555;--btn:#111;--btnText:#fff;}
    body{margin:0;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--text);}
    .wrap{max-width:980px;margin:0 auto;padding:28px 18px 60px;}
    .top{display:flex;justify-content:space-between;align-items:flex-end;gap:10px;flex-wrap:wrap;}
    h1{margin:0;font-size:22px;}
    .sub{margin:6px 0 0;color:var(--muted);font-size:14px;line-height:1.4;}
    .card{margin-top:18px;background:var(--card);border:1px solid var(--border);border-radius:14px;padding:18px 18px 16px;box-shadow:0 6px 18px rgba(0,0,0,0.06);}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
    @media (max-width:820px){.grid{grid-template-columns:1fr;}}
    label{display:block;font-size:13px;color:#222;margin:2px 0 6px;}
    input,textarea,select{
      width:100%;box-sizing:border-box;border:1px solid var(--border);border-radius:10px;
      padding:10px 12px;font-size:14px;background:#fff;color:#111;
    }
    textarea{min-height:84px;resize:vertical;}
    .row{margin-top:10px;}
    .btnRow{display:flex;gap:10px;flex-wrap:wrap;margin-top:14px;align-items:center;}
    button{
      border:0;border-radius:12px;background:var(--btn);color:var(--btnText);
      padding:11px 14px;font-size:14px;cursor:pointer;
    }
    button:disabled{opacity:.6;cursor:not-allowed;}
    .ghost{background:#fff;color:#111;border:1px solid var(--border);}
    .status{font-size:13px;color:var(--muted);}
    .hr{height:1px;background:var(--border);margin:16px 0;}
    .hint{font-size:12px;color:var(--muted);line-height:1.45;margin-top:6px;}
    .mini{font-size:12px;color:var(--muted);}
    .pill{display:inline-block;font-size:12px;border:1px solid var(--border);border-radius:999px;padding:4px 10px;background:#fff;color:#333}
    .error{color:#b00020;}
    .ok{color:#0a6;}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div>
        <h1>LRID™ Assessment</h1>
        <p class="sub">Complete the form and click <b>Send response</b>. The report will be generated and emailed to the designated address.</p>
      </div>
      <div class="pill" id="healthPill">API: checking…</div>
    </div>

    <div class="card">
      <div class="grid">
        <div>
          <label for="name">Respondent name</label>
          <input id="name" placeholder="Full name" autocomplete="name" />
        </div>
        <div>
          <label for="email">Respondent email (report recipient)</label>
          <input id="email" placeholder="name@company.com" autocomplete="email" />
          <div class="hint">This email will be used to send the PDF report.</div>
        </div>
        <div>
          <label for="org">Organization</label>
          <input id="org" placeholder="Company / Institution" />
        </div>
        <div>
          <label for="caseId">Case ID (optional)</label>
          <input id="caseId" placeholder="Leave empty to auto-generate" />
          <div class="hint">If you provide one, it must be unique.</div>
        </div>
      </div>

      <div class="hr"></div>

      <label for="answersJson">Answers (JSON)</label>
      <textarea id="answersJson" placeholder='Paste answers JSON array here (advanced) OR use the example below.'></textarea>
      <div class="hint">
        If your UI already collects answers elsewhere, you can ignore this field and wire the submit payload accordingly.
        This page includes a simple JSON-based fallback so you can always test end-to-end.
      </div>

      <div class="row">
        <div class="mini">Example answers format:</div>
        <pre class="mini" style="white-space:pre-wrap;margin:6px 0 0;background:#fff;border:1px solid var(--border);border-radius:12px;padding:10px;">
[
  {"question_id":"DI01","value":5},
  {"question_id":"RP02","value":3},
  {"question_id":"MA03","value":"Agree"},
  {"question_id":"AC04","value":4},
  {"question_id":"PR05","value":2},
  {"question_id":"ED06","value":"Strongly agree"}
]
        </pre>
      </div>

      <div class="btnRow">
        <button id="sendBtn" onclick="submitForm()">Send response</button>
        <button class="ghost" onclick="fillExample()">Fill example</button>
        <span class="status" id="status"></span>
      </div>

      <div class="hint" id="lastResult"></div>
    </div>
  </div>

  <script>
    async function checkHealth() {
      const pill = document.getElementById("healthPill");
      try {
        const r = await fetch("/api/health", { cache: "no-store" });
        const j = await r.json();
        pill.textContent = j && j.status === "ok" ? "API: OK" : "API: issue";
      } catch (e) {
        pill.textContent = "API: offline";
      }
    }
    checkHealth();

    function setStatus(msg, cls) {
      const s = document.getElementById("status");
      s.className = "status " + (cls || "");
      s.textContent = msg || "";
    }

    function fillExample() {
      document.getElementById("answersJson").value = JSON.stringify([
        { question_id: "DI01", value: 5 },
        { question_id: "RP02", value: 3 },
        { question_id: "MA03", value: "Agree" },
        { question_id: "AC04", value: 4 },
        { question_id: "PR05", value: 2 },
        { question_id: "ED06", value: "Strongly agree" }
      ], null, 2);
    }

    function safeJsonParse(text) {
      if (!text || !String(text).trim()) return null;
      try { return JSON.parse(text); } catch { return null; }
    }

    async function submitForm() {
      const btn = document.getElementById("sendBtn");
      const last = document.getElementById("lastResult");
      last.textContent = "";
      last.className = "hint";

      const respondent = {
        name: document.getElementById("name").value.trim(),
        email: document.getElementById("email").value.trim(),
        organization: document.getElementById("org").value.trim()
      };

      const caseId = document.getElementById("caseId").value.trim();
      const answersRaw = document.getElementById("answersJson").value;
      const answers = safeJsonParse(answersRaw);

      // Minimal validation (non-blocking but helpful)
      if (!respondent.email) {
        last.textContent = "Please provide respondent email (report recipient).";
        last.className = "hint error";
        return;
      }
      if (answersRaw.trim() && !answers) {
        last.textContent = "Answers JSON is invalid. Fix it or clear the field.";
        last.className = "hint error";
        return;
      }

      const payload = {
        ...(caseId ? { case_id: caseId } : {}),
        respondent,
        answers: Array.isArray(answers) ? answers : []
      };

      btn.disabled = true;
      setStatus("Submitting…");

      try {
        const res = await fetch("/api/intake/submit", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        const data = await res.json().catch(() => null);

        if (!res.ok || !data) {
          throw new Error((data && data.error) ? data.error : ("HTTP " + res.status));
        }

        // ✅ redirect to thank-you if provided
        if (data.ok && data.thank_you_url) {
          window.location.href = data.thank_you_url;
          return;
        }

        // fallback
        setStatus("Submitted.", "ok");
        last.textContent = "Submitted successfully.";
        last.className = "hint ok";
      } catch (e) {
        setStatus("Error.", "error");
        last.textContent = "Submit failed: " + (e && e.message ? e.message : String(e));
        last.className = "hint error";
      } finally {
        btn.disabled = false;
      }
    }
  </script>
</body>
</html>
