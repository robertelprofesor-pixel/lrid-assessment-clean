<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LRID™ Assessment</title>
  <style>
    :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --border:#e6e7ee;
      --primary:#2563eb;
      --primary2:#1d4ed8;
      --danger:#ef4444;
      --ok:#16a34a;
      --shadow: 0 10px 28px rgba(2,6,23,.08);
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      color:var(--text);
      background:var(--bg);
    }
    a{color:var(--primary); text-decoration:none}
    a:hover{text-decoration:underline}

    .wrap{max-width:980px; margin:0 auto; padding:22px 16px 80px;}

    .topbar{
      position:sticky; top:0; z-index:20;
      backdrop-filter:saturate(140%) blur(8px);
      background:rgba(246,247,251,.78);
      border-bottom:1px solid rgba(230,231,238,.7);
    }
    .topbar-inner{max-width:980px; margin:0 auto; padding:12px 16px;}
    .titleRow{display:flex; gap:14px; align-items:flex-start; justify-content:space-between;}
    .brand{display:flex; gap:12px; align-items:center}
    .logo{
      width:42px; height:42px; border-radius:12px;
      background: radial-gradient(circle at 25% 20%, #60a5fa, #2563eb 55%, #1e40af 100%);
      box-shadow:0 10px 18px rgba(37,99,235,.25);
      flex:0 0 auto;
    }
    h1{font-size:22px; line-height:1.2; margin:0}
    .subtitle{margin:4px 0 0; color:var(--muted); font-size:14.5px}

    .pill{
      display:inline-flex; align-items:center; gap:8px;
      border:1px solid var(--border);
      background:#fff;
      border-radius:999px;
      padding:8px 12px;
      font-size:13px;
      color:var(--muted);
      white-space:nowrap;
    }
    .dot{width:8px; height:8px; border-radius:999px; background:var(--ok)}

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
    }
    .section{margin-top:16px}
    .cardPad{padding:18px}

    .grid2{display:grid; grid-template-columns:1fr 1fr; gap:14px}
    @media (max-width: 820px){ .grid2{grid-template-columns:1fr} }

    label{display:block; font-size:13px; color:var(--muted); margin:0 0 6px}
    .req{color:var(--danger); font-weight:700; margin-left:6px}

    input[type="text"], input[type="email"]{
      width:100%;
      height:44px;
      border-radius:12px;
      border:1px solid var(--border);
      padding:10px 12px;
      font-size:16px;
      outline:none;
      background:#fff;
    }
    input[type="text"]:focus, input[type="email"]:focus{
      border-color:rgba(37,99,235,.55);
      box-shadow:0 0 0 4px rgba(37,99,235,.15);
    }

    .progressRow{display:flex; align-items:center; justify-content:space-between; gap:12px; margin-top:10px}
    .progressText{font-size:13px; color:var(--muted); white-space:nowrap}
    .bar{height:10px; border-radius:999px; background:#eef2ff; border:1px solid var(--border); overflow:hidden; flex:1}
    .bar > div{height:100%; width:0%; background:linear-gradient(90deg, #2563eb, #60a5fa); border-radius:999px}

    .qCard{padding:16px; border-top:1px solid var(--border)}
    .qHead{display:flex; align-items:flex-start; justify-content:space-between; gap:12px}
    .qId{font-weight:700; font-size:13px; color:#111827}
    .qText{margin:6px 0 0; font-size:16px; line-height:1.45}

    .scaleHint{
      margin-top:8px;
      font-size:13px;
      color:var(--muted);
      line-height:1.35;
    }
    .scaleHint strong{color:#0f172a; font-weight:700}

    .options{display:grid; gap:10px; margin-top:12px}

    .opt{
      display:flex; gap:10px; align-items:flex-start;
      border:1px solid var(--border);
      border-radius:14px;
      padding:12px 12px;
      background:#fff;
    }
    .opt:hover{border-color:rgba(37,99,235,.35)}
    .opt input{margin-top:2px; transform:scale(1.1)}
    .opt .optText{font-size:15px; line-height:1.35}

    .actions{
      display:flex; gap:12px; justify-content:flex-end; align-items:center;
      padding:16px; border-top:1px solid var(--border);
      border-radius:0 0 var(--radius) var(--radius);
      background:linear-gradient(180deg, #fff, #fbfbff);
    }
    .btn{
      height:44px;
      padding:0 16px;
      border-radius:12px;
      border:1px solid var(--border);
      background:#fff;
      color:var(--text);
      font-weight:700;
      font-size:15px;
      cursor:pointer;
    }
    .btn:hover{border-color:rgba(15,23,42,.25)}
    .btnPrimary{
      border-color:rgba(37,99,235,.35);
      background:var(--primary);
      color:#fff;
    }
    .btnPrimary:hover{background:var(--primary2)}
    .btn:disabled{opacity:.65; cursor:not-allowed}

    .errorBox{
      margin-top:14px;
      border:1px solid rgba(239,68,68,.35);
      background:rgba(239,68,68,.06);
      color:#7f1d1d;
      padding:12px 12px;
      border-radius:14px;
      font-size:14px;
      display:none;
      white-space:pre-wrap;
    }

    .footerNote{
      padding:12px 18px 0;
      color:var(--muted);
      font-size:13px;
      line-height:1.45;
    }

    /* Mobile tuning */
    @media (max-width: 520px){
      .topbar-inner{padding:12px 14px;}
      .wrap{padding:18px 14px 72px;}
      h1{font-size:20px;}
      .subtitle{font-size:13.5px;}
      .pill{padding:7px 10px; font-size:12.5px;}
      .progressRow{flex-direction:column; align-items:stretch; gap:8px;}
      .progressText{white-space:normal;}
      .qText{font-size:16px;}
      .opt{padding:11px 11px;}
      .opt .optText{font-size:15px;}
      .actions{flex-direction:column-reverse; align-items:stretch;}
      .btn{width:100%;}
    }
  </style>
</head>

<body>
  <div class="topbar">
    <div class="topbar-inner">
      <div class="titleRow">
        <div class="brand">
          <div class="logo" aria-hidden="true"></div>
          <div>
            <h1>LRID™ Assessment</h1>
            <div class="subtitle">Executive Decision Integrity · Structured Questionnaire</div>
          </div>
        </div>
        <div class="pill" title="Configuration status">
          <span class="dot" id="cfgDot"></span>
          <span id="cfgText">Config: loading…</span>
        </div>
      </div>

      <div class="progressRow" style="margin-top:14px;">
        <div class="bar" aria-label="progress">
          <div id="barFill"></div>
        </div>
        <div class="progressText">
          <span id="pct">0%</span> · <span id="count">0</span>/<span id="total">0</span> required answered
        </div>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="card section">
      <div class="cardPad">
        <div style="font-size:14px; color:var(--muted); margin-bottom:12px;">
          Answer all required items. Your report will be generated and sent to the email address provided below.
        </div>

        <div class="grid2">
          <div>
            <label for="name">Full name <span class="req">*</span></label>
            <input id="name" type="text" placeholder="e.g., Robert Karaszewski" autocomplete="name" />
          </div>
          <div>
            <label for="email">Email (report delivery) <span class="req">*</span></label>
            <input id="email" type="email" placeholder="name@company.com" autocomplete="email" />
          </div>
        </div>

        <div style="margin-top:12px;">
          <label for="org">Organization</label>
          <input id="org" type="text" placeholder="Company / Institution" autocomplete="organization" />
        </div>

        <div class="errorBox" id="topError"></div>
      </div>

      <div id="questionsRoot"></div>

      <div class="actions">
        <button class="btn" id="resetBtn" type="button">Reset answers</button>
        <button class="btn btnPrimary" id="submitBtn" type="button">Send responses</button>
      </div>

      <div class="footerNote">
        By submitting, you confirm the information is accurate. The report is interpretive and intended to support executive-level discussion.
      </div>
    </div>
  </div>

<script>
  // -----------------------------
  // Config loading
  // -----------------------------
  const CONFIG_URL = "/config/questions.lrid.v1.json";

  const elCfgText = document.getElementById("cfgText");
  const elCfgDot  = document.getElementById("cfgDot");
  const elTopErr  = document.getElementById("topError");

  const elBarFill = document.getElementById("barFill");
  const elPct     = document.getElementById("pct");
  const elCount   = document.getElementById("count");
  const elTotal   = document.getElementById("total");

  const elName = document.getElementById("name");
  const elEmail = document.getElementById("email");
  const elOrg = document.getElementById("org");

  const elRoot = document.getElementById("questionsRoot");
  const elReset = document.getElementById("resetBtn");
  const elSubmit = document.getElementById("submitBtn");

  function setCfg(ok, msg){
    elCfgText.textContent = msg;
    elCfgDot.style.background = ok ? "var(--ok)" : "var(--danger)";
  }

  function showTopError(msg){
    if(!msg){
      elTopErr.style.display = "none";
      elTopErr.textContent = "";
      return;
    }
    elTopErr.style.display = "block";
    elTopErr.textContent = msg;
  }

  function normalizeQuestions(cfg){
    // UI expects: either array of questions OR {questions:[...]} OR {dimensions:[{questions:[...]}]}
    if(Array.isArray(cfg)) return cfg;
    if(cfg && Array.isArray(cfg.questions)) return cfg.questions;

    // Dimension-based: { meta, dimensions:[{id,name,questions:[...]}] }
    if(cfg && Array.isArray(cfg.dimensions)){
      const out = [];
      for(const d of cfg.dimensions){
        const qs = Array.isArray(d.questions) ? d.questions : [];
        for(const q of qs){
          out.push({
            ...q,
            dimension_id: d.id,
            dimension_name: d.name
          });
        }
      }
      return out;
    }
    return [];
  }

  // -----------------------------
  // Scale anchors (per-question overrides)
  // -----------------------------
  const SCALE_ANCHOR_OVERRIDES = {
    "DI-02": { min: "Not willing at all", max: "Extremely willing" },
    "MA-06": { min: "Never", max: "Very often" }
    // RP-04 is already self-describing in question text; no override needed.
  };

  function getScaleAnchors(q){
    const qid = q.id || q.question_id || "";
    if(SCALE_ANCHOR_OVERRIDES[qid]) return SCALE_ANCHOR_OVERRIDES[qid];

    // If question text already includes anchors like "(1 = ...; 5 = ...)" or "(1 = ...; 5 = ...)"
    // we do not add another line to avoid duplication.
    const t = String(q.text || "");
    const hasAnchors = /\b1\s*=\s*.+\b5\s*=\s*/i.test(t) || /\b1\s*=\s*.+\b5\s*=\s*/i.test(t);
    if(hasAnchors) return null;

    return null;
  }

  // -----------------------------
  // Rendering + state
  // -----------------------------
  const state = {
    cfg: null,
    questions: [],
    answers: {}, // { [questionId]: value }
    requiredIds: []
  };

  function isRequired(q){
    // Treat every question as required unless explicitly "required": false.
    return q.required !== false;
  }

  function updateProgress(){
    const totalReq = state.requiredIds.length;
    let answered = 0;
    for(const id of state.requiredIds){
      const v = state.answers[id];
      if(v !== undefined && v !== null && String(v).length > 0) answered++;
    }
    const pct = totalReq ? Math.round((answered/totalReq)*100) : 0;
    elTotal.textContent = String(totalReq);
    elCount.textContent = String(answered);
    elPct.textContent = pct + "%";
    elBarFill.style.width = pct + "%";
  }

  function render(){
    elRoot.innerHTML = "";

    // Group by dimension for nicer flow
    const byDim = new Map();
    for(const q of state.questions){
      const key = q.dimension_name || "General";
      if(!byDim.has(key)) byDim.set(key, []);
      byDim.get(key).push(q);
    }

    for(const [dimName, questions] of byDim.entries()){
      const dimHeader = document.createElement("div");
      dimHeader.className = "qCard";
      dimHeader.style.background = "rgba(15,23,42,.02)";
      dimHeader.innerHTML = `
        <div class="qHead">
          <div>
            <div class="qId">${escapeHtml(dimName)} · ${questions.length} item(s)</div>
          </div>
        </div>
      `;
      elRoot.appendChild(dimHeader);

      for(const q of questions){
        elRoot.appendChild(renderQuestion(q));
      }
    }

    updateProgress();
  }

  function renderQuestion(q){
    const qId = q.id || q.question_id;
    const required = isRequired(q);

    const wrap = document.createElement("div");
    wrap.className = "qCard";

    // Head
    const head = document.createElement("div");
    head.className = "qHead";
    head.innerHTML = `
      <div style="flex:1">
        <div class="qId">${escapeHtml(qId || "Q")}${required ? ' <span class="req">*</span>' : ""}</div>
        <div class="qText">${escapeHtml(q.text || q.label || "")}</div>
      </div>
    `;
    wrap.appendChild(head);

    // Scale hint (only for scale questions that need anchors)
    if(q.type === "scale"){
      const anchors = getScaleAnchors(q);
      if(anchors && (anchors.min || anchors.max)){
        const hint = document.createElement("div");
        hint.className = "scaleHint";
        hint.innerHTML = `<strong>Scale:</strong> 1 — ${escapeHtml(anchors.min)} · 5 — ${escapeHtml(anchors.max)}`;
        wrap.appendChild(hint);
      }
    }

    // Options
    const opts = document.createElement("div");
    opts.className = "options";

    if(q.type === "scale"){
      const min = (q.scale && Number.isFinite(q.scale.min)) ? q.scale.min : 1;
      const max = (q.scale && Number.isFinite(q.scale.max)) ? q.scale.max : 5;

      for(let v = min; v <= max; v++){
        opts.appendChild(optionRadio(qId, String(v), String(v)));
      }
    } else {
      const options = Array.isArray(q.options) ? q.options : [];
      let idx = 0;
      for(const o of options){
        idx++;
        const label = o.label ?? o.text ?? ("Option " + idx);
        // store score if provided, else store label
        const value = (o.score !== undefined && o.score !== null) ? String(o.score) : String(label);
        opts.appendChild(optionRadio(qId, value, label));
      }
    }

    wrap.appendChild(opts);
    return wrap;
  }

  function optionRadio(questionId, value, labelText){
    const row = document.createElement("label");
    row.className = "opt";

    const input = document.createElement("input");
    input.type = "radio";
    input.name = questionId;
    input.value = value;
    input.checked = (state.answers[questionId] === value);

    input.addEventListener("change", () => {
      state.answers[questionId] = value;
      saveDraft();
      updateProgress();
    });

    const txt = document.createElement("div");
    txt.className = "optText";
    txt.textContent = labelText;

    row.appendChild(input);
    row.appendChild(txt);
    return row;
  }

  function escapeHtml(s){
    return String(s ?? "")
      .replace(/&/g,"&amp;")
      .replace(/</g,"&lt;")
      .replace(/>/g,"&gt;")
      .replace(/"/g,"&quot;")
      .replace(/'/g,"&#039;");
  }

  // -----------------------------
  // Draft persistence
  // -----------------------------
  const DRAFT_KEY = "lrid_assessment_draft_v1";

  function saveDraft(){
    try{
      const draft = {
        respondent: {
          name: elName.value || "",
          email: elEmail.value || "",
          organization: elOrg.value || ""
        },
        answers: state.answers
      };
      localStorage.setItem(DRAFT_KEY, JSON.stringify(draft));
    }catch(e){}
  }

  function loadDraft(){
    try{
      const raw = localStorage.getItem(DRAFT_KEY);
      if(!raw) return;
      const d = JSON.parse(raw);
      if(d?.respondent){
        elName.value = d.respondent.name || "";
        elEmail.value = d.respondent.email || "";
        elOrg.value = d.respondent.organization || "";
      }
      if(d?.answers && typeof d.answers === "object"){
        state.answers = d.answers;
      }
    }catch(e){}
  }

  function clearDraft(){
    try{ localStorage.removeItem(DRAFT_KEY); }catch(e){}
    state.answers = {};
    elName.value = "";
    elEmail.value = "";
    elOrg.value = "";
    render();
    showTopError(null);
  }

  // -----------------------------
  // Submit
  // -----------------------------
  function validate(){
    const name = (elName.value || "").trim();
    const email = (elEmail.value || "").trim();

    if(!name) return "Please provide Full name.";
    if(!email) return "Please provide Email (report delivery).";

    const missing = [];
    for(const id of state.requiredIds){
      const v = state.answers[id];
      if(v === undefined || v === null || String(v).length === 0){
        missing.push(id);
      }
    }
    if(missing.length){
      return "Please answer all required items. Missing: " + missing.slice(0,12).join(", ") + (missing.length>12 ? "…" : "");
    }
    return null;
  }

  async function submit(){
    showTopError(null);

    const err = validate();
    if(err){
      showTopError(err);
      window.scrollTo({ top: 0, behavior: "smooth" });
      return;
    }

    elSubmit.disabled = true;
    elSubmit.textContent = "Sending…";

    const payload = {
      respondent: {
        name: (elName.value || "").trim(),
        email: (elEmail.value || "").trim(),
        organization: (elOrg.value || "").trim()
      },
      answers: Object.keys(state.answers).map((question_id) => ({
        question_id,
        value: state.answers[question_id]
      }))
    };

    try{
      const r = await fetch("/api/intake/submit", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify(payload)
      });
      const data = await r.json();
      if(!r.ok || !data || data.ok !== true){
        throw new Error((data && data.error) ? data.error : "Submit failed.");
      }

      if(data.thank_you_url){
        clearDraft();
        window.location.href = data.thank_you_url;
        return;
      }

      clearDraft();
      window.location.href = "/thank-you?emailed=" + encodeURIComponent(String(data.emailed || false));
    }catch(e){
      showTopError("Submit failed: " + (e?.message || String(e)));
      window.scrollTo({ top: 0, behavior: "smooth" });
    }finally{
      elSubmit.disabled = false;
      elSubmit.textContent = "Send responses";
    }
  }

  // -----------------------------
  // Boot
  // -----------------------------
  (async function boot(){
    setCfg(true, "Config: loading…");
    loadDraft();

    elName.addEventListener("input", saveDraft);
    elEmail.addEventListener("input", saveDraft);
    elOrg.addEventListener("input", saveDraft);

    elReset.addEventListener("click", () => clearDraft());
    elSubmit.addEventListener("click", () => submit());

    try{
      const r = await fetch(CONFIG_URL, { cache:"no-store" });
      if(!r.ok) throw new Error("Cannot load config (" + r.status + ")");
      const cfg = await r.json();
      state.cfg = cfg;

      state.questions = normalizeQuestions(cfg);
      if(!state.questions.length){
        setCfg(false, "Config: invalid");
        showTopError("No questions found in config. Please verify the JSON structure (dimensions/questions).");
        return;
      }

      state.requiredIds = state.questions
        .filter(isRequired)
        .map(q => q.id || q.question_id)
        .filter(Boolean);

      setCfg(true, "Config: loaded");
      render();
      updateProgress();

    }catch(e){
      setCfg(false, "Config: failed");
      showTopError("Config load failed: " + (e?.message || String(e)));
    }
  })();
</script>
</body>
</html>
