<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LRID™ Assessment</title>
  <style>
    :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#475569;
      --line:#e5e7eb;
      --brand:#0b5fff;
      --danger:#b42318;
      --ok:#067647;
      --shadow: 0 10px 30px rgba(2,6,23,.08);
      --radius: 16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
      background:var(--bg);
      color:var(--text);
    }
    a{color:var(--brand);text-decoration:none}
    a:hover{text-decoration:underline}
    .wrap{max-width:980px;margin:0 auto;padding:28px 16px 70px}
    .topbar{
      display:flex;align-items:center;justify-content:space-between;gap:16px;
      margin-bottom:14px;
    }
    .brand{
      display:flex;align-items:flex-start;gap:12px;
    }
    .logo{
      width:44px;height:44px;border-radius:12px;
      background:linear-gradient(135deg, #0b5fff, #7c3aed);
      box-shadow: var(--shadow);
    }
    .brand h1{margin:0;font-size:18px;line-height:1.1}
    .brand p{margin:2px 0 0;color:var(--muted);font-size:13px}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 10px;border-radius:999px;border:1px solid var(--line);
      background:#fff;color:var(--muted);font-size:12px;
    }
    .grid{display:grid;grid-template-columns: 1.2fr .8fr;gap:16px}
    @media(max-width: 920px){.grid{grid-template-columns: 1fr}}
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow: var(--shadow);
      padding:18px;
    }
    .card h2{margin:0 0 10px;font-size:16px}
    .card p{margin:8px 0;color:var(--muted);line-height:1.55}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .field{flex:1;min-width:220px}
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    input, select{
      width:100%;
      padding:12px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      outline:none;
      background:#fff;
      font-size:14px;
    }
    input:focus, select:focus{border-color:#bfd3ff; box-shadow:0 0 0 4px rgba(11,95,255,.08)}
    .divider{height:1px;background:var(--line);margin:14px 0}
    .progress{
      height:10px;border-radius:999px;background:#eef2ff;overflow:hidden;border:1px solid #e7eafe;
    }
    .bar{height:100%;width:0;background:linear-gradient(90deg,#0b5fff,#7c3aed)}
    .small{font-size:12px;color:var(--muted)}
    .status{font-size:12px;margin-top:8px}
    .status.ok{color:var(--ok)}
    .status.err{color:var(--danger)}
    .q{
      padding:14px 14px;
      border-radius:14px;
      border:1px solid var(--line);
      margin-bottom:12px;
      background:#fff;
    }
    .qhead{display:flex;justify-content:space-between;gap:10px;align-items:flex-start}
    .qid{font-size:11px;color:#64748b}
    .qtitle{font-size:14px;font-weight:650;line-height:1.35;margin:4px 0 0}
    .qmeta{font-size:11px;color:#64748b;margin-top:4px}
    .req{color:var(--danger);font-weight:700;margin-left:6px}
    .scale{
      margin-top:12px;
      display:grid;
      grid-template-columns: repeat(5, minmax(0, 1fr));
      gap:10px;
      align-items:stretch;
    }
    @media(max-width: 520px){
      .scale{grid-template-columns: repeat(2, minmax(0, 1fr))}
    }
    .opt{
      border:1px solid var(--line);
      border-radius:12px;
      padding:10px 10px;
      cursor:pointer;
      background:#fff;
      user-select:none;
      transition: .12s ease;
      min-height:52px;
      display:flex;flex-direction:column;justify-content:center;
    }
    .opt:hover{border-color:#c7d2fe; box-shadow:0 0 0 4px rgba(124,58,237,.06)}
    .opt strong{font-size:13px}
    .opt span{font-size:11px;color:#64748b;margin-top:2px;line-height:1.2}
    .opt.sel{
      border-color:#7c3aed;
      box-shadow:0 0 0 4px rgba(124,58,237,.12);
      background: #faf7ff;
    }
    .actions{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-top:14px}
    .btn{
      appearance:none;border:none;cursor:pointer;
      padding:12px 14px;border-radius:12px;
      font-weight:650;font-size:14px;
      background:var(--brand);color:#fff;
      box-shadow: var(--shadow);
    }
    .btn:disabled{opacity:.55;cursor:not-allowed}
    .btn.secondary{background:#fff;color:var(--text);border:1px solid var(--line);box-shadow:none}
    .warnbox{
      border:1px solid #ffd7d7;
      background:#fff5f5;
      color:#7a1414;
      padding:12px;border-radius:14px;
      margin-top:12px;
      font-size:13px;
      line-height:1.45;
    }
    .footnote{margin-top:10px;font-size:12px;color:#64748b;line-height:1.5}
    .sticky{
      position:sticky;top:12px;
    }
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <h1>LRID™ Assessment</h1>
          <p>Executive Decision Integrity · Structured Questionnaire</p>
        </div>
      </div>
      <div class="pill">
        <span>Config:</span>
        <span id="cfgState" class="mono">loading…</span>
      </div>
    </div>

    <div class="grid">
      <!-- MAIN -->
      <div class="card" id="mainCard">
        <h2>Assessment</h2>
        <p id="introText">
          Loading questionnaire…
        </p>

        <div class="divider"></div>

        <div class="row">
          <div class="field">
            <label for="name">Full name <span class="req">*</span></label>
            <input id="name" autocomplete="name" placeholder="e.g., Robert Karaszewski" />
          </div>
          <div class="field">
            <label for="email">Email (report delivery) <span class="req">*</span></label>
            <input id="email" type="email" autocomplete="email" placeholder="name@company.com" />
          </div>
          <div class="field">
            <label for="org">Organization</label>
            <input id="org" autocomplete="organization" placeholder="Company / Institution" />
          </div>
        </div>

        <div class="divider"></div>

        <div class="progress" aria-label="Progress">
          <div class="bar" id="bar"></div>
        </div>
        <div class="row" style="justify-content:space-between;margin-top:10px">
          <div class="small" id="progText">0% complete</div>
          <div class="small" id="countText">0 / 0 answered</div>
        </div>

        <div id="warn" class="warnbox" style="display:none"></div>

        <div class="divider"></div>

        <div id="questionList"></div>

        <div class="actions">
          <button class="btn secondary" id="btnReset" type="button">Reset answers</button>
          <button class="btn" id="btnSubmit" type="button">Send responses</button>
          <div class="status" id="status"></div>
        </div>

        <div class="footnote">
          By submitting, you confirm the information is accurate. The report is interpretive and intended to support executive-level discussion.
        </div>
      </div>

      <!-- SIDE -->
      <div class="card sticky">
        <h2>Quality Controls</h2>
        <p>
          This UI always loads configuration from:
          <span class="mono">/config/questions.lrid.v1.json</span>
        </p>
        <div class="divider"></div>
        <p class="small">
          If config cannot be loaded or parsed, the app will stop and show diagnostics instead of silently falling back.
        </p>
        <div class="divider"></div>
        <p class="small">
          Submission endpoint:
          <span class="mono">POST /api/intake/submit</span>
        </p>
        <p class="small">
          After submit, the UI redirects to backend:
          <span class="mono">thank_you_url</span>
        </p>
        <div class="divider"></div>
        <p class="small">
          Diagnostics:
          <a href="/api/health" target="_blank" rel="noopener">/api/health</a> ·
          <a href="/config/questions.lrid.v1.json" target="_blank" rel="noopener">/config/questions.lrid.v1.json</a>
        </p>
      </div>
    </div>
  </div>

<script>
(() => {
  const CONFIG_URL = "/config/questions.lrid.v1.json";

  const elCfg = document.getElementById("cfgState");
  const elIntro = document.getElementById("introText");
  const elList = document.getElementById("questionList");
  const elBar = document.getElementById("bar");
  const elProg = document.getElementById("progText");
  const elCount = document.getElementById("countText");
  const elWarn = document.getElementById("warn");
  const elStatus = document.getElementById("status");
  const btnSubmit = document.getElementById("btnSubmit");
  const btnReset = document.getElementById("btnReset");

  const elName = document.getElementById("name");
  const elEmail = document.getElementById("email");
  const elOrg = document.getElementById("org");

  let QUESTIONS = [];
  let ANSWERS = new Map(); // question_id -> value
  let META = { title: "LRID™ Assessment", version: "unknown" };

  function setStatus(msg, type){
    elStatus.textContent = msg || "";
    elStatus.className = "status" + (type ? (" " + type) : "");
  }

  function showWarn(html){
    elWarn.style.display = "block";
    elWarn.innerHTML = html;
  }
  function hideWarn(){
    elWarn.style.display = "none";
    elWarn.innerHTML = "";
  }

  function normalizeConfig(raw){
    // supports:
    // 1) [ {id, text, ...}, ... ]
    // 2) { questions:[...], meta:{...} }
    // 3) { items:[...] }
    let questions = [];
    let meta = {};
    if (Array.isArray(raw)) {
      questions = raw;
    } else if (raw && typeof raw === "object") {
      meta = raw.meta || raw.info || {};
      questions = raw.questions || raw.items || raw.data || [];
    }
    if (!Array.isArray(questions)) questions = [];

    // normalize each question
    questions = questions
      .map((q, idx) => {
        const id = String(q.id || q.question_id || q.qid || ("Q" + (idx+1)));
        const text = String(q.text || q.question || q.title || "");
        const section = String(q.section || q.dimension || q.group || "General");
        const required = (q.required !== undefined) ? Boolean(q.required) : true;

        // Likert default 1..5 if options missing
        const options = Array.isArray(q.options) && q.options.length
          ? q.options.map((o, oi) => ({
              value: (o.value !== undefined ? o.value : (oi+1)),
              label: String(o.label || o.text || o.name || ("Option " + (oi+1))),
              hint: (o.hint ? String(o.hint) : "")
            }))
          : [
              { value: 1, label: "Strongly Disagree", hint: "Clear rejection" },
              { value: 2, label: "Disagree", hint: "Mostly no" },
              { value: 3, label: "Neutral", hint: "Mixed / uncertain" },
              { value: 4, label: "Agree", hint: "Mostly yes" },
              { value: 5, label: "Strongly Agree", hint: "Clear confirmation" },
            ];

        return {
          id, text, section, required,
          options,
          weight: (q.weight !== undefined ? Number(q.weight) : 1),
          reverse: Boolean(q.reverse || q.reverse_scored || false)
        };
      })
      .filter(q => q.text && q.text.trim().length > 0);

    return {
      meta,
      questions
    };
  }

  function groupBySection(questions){
    const map = new Map();
    for (const q of questions){
      const key = q.section || "General";
      if (!map.has(key)) map.set(key, []);
      map.get(key).push(q);
    }
    return map;
  }

  function render(){
    elList.innerHTML = "";
    hideWarn();

    if (!QUESTIONS.length) {
      elIntro.textContent = "No questions found in config. Please verify the JSON structure.";
      showWarn(
        `<strong>Config loaded but contains zero questions.</strong><br/>
         The UI expects either an array of questions or { "questions": [...] }.<br/>
         Open <a href="${CONFIG_URL}" target="_blank" rel="noopener">${CONFIG_URL}</a> and verify the content.`
      );
      updateProgress();
      return;
    }

    elIntro.textContent =
      "Answer all required items. Your report will be generated and sent to the email address provided above.";

    const groups = groupBySection(QUESTIONS);

    for (const [section, qs] of groups.entries()){
      const sec = document.createElement("div");
      sec.style.marginBottom = "14px";

      const h = document.createElement("div");
      h.style.display = "flex";
      h.style.justifyContent = "space-between";
      h.style.alignItems = "baseline";
      h.style.gap = "10px";
      h.innerHTML = `<div style="font-weight:800;font-size:14px">${escapeHtml(section)}</div>
                     <div class="small">${qs.length} item(s)</div>`;
      sec.appendChild(h);

      const spacer = document.createElement("div");
      spacer.className = "divider";
      spacer.style.margin = "10px 0 12px";
      sec.appendChild(spacer);

      qs.forEach((q, idx) => {
        const wrap = document.createElement("div");
        wrap.className = "q";
        wrap.dataset.qid = q.id;

        const selected = ANSWERS.get(q.id);

        const head = document.createElement("div");
        head.className = "qhead";

        head.innerHTML =
          `<div>
             <div class="qid">${escapeHtml(q.id)}${q.required ? '<span class="req">*</span>' : ''}</div>
             <div class="qtitle">${escapeHtml(q.text)}</div>
             <div class="qmeta">Scale: 1–5 · ${q.reverse ? 'Reverse-scored' : 'Direct-scored'} · Weight: ${q.weight}</div>
           </div>`;

        wrap.appendChild(head);

        const scale = document.createElement("div");
        scale.className = "scale";

        q.options.slice(0,5).forEach(opt => {
          const btn = document.createElement("div");
          btn.className = "opt" + (String(selected) === String(opt.value) ? " sel" : "");
          btn.tabIndex = 0;
          btn.role = "button";
          btn.setAttribute("aria-pressed", String(selected) === String(opt.value) ? "true" : "false");
          btn.innerHTML = `<strong>${escapeHtml(String(opt.value))}. ${escapeHtml(opt.label)}</strong>
                           <span>${escapeHtml(opt.hint || "")}</span>`;

          btn.addEventListener("click", () => {
            ANSWERS.set(q.id, opt.value);
            render(); // simple + robust
            updateProgress();
          });
          btn.addEventListener("keydown", (e) => {
            if (e.key === "Enter" || e.key === " ") {
              e.preventDefault();
              ANSWERS.set(q.id, opt.value);
              render();
              updateProgress();
            }
          });
          scale.appendChild(btn);
        });

        wrap.appendChild(scale);
        sec.appendChild(wrap);
      });

      elList.appendChild(sec);
    }

    updateProgress();
  }

  function escapeHtml(str){
    return String(str ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function updateProgress(){
    const required = QUESTIONS.filter(q => q.required);
    const answeredRequired = required.filter(q => ANSWERS.has(q.id));
    const totalReq = required.length || 1;
    const pct = Math.round((answeredRequired.length / totalReq) * 100);

    elBar.style.width = pct + "%";
    elProg.textContent = pct + "% complete";
    elCount.textContent = `${answeredRequired.length} / ${required.length} required answered`;
  }

  function validate(){
    const problems = [];
    const name = elName.value.trim();
    const email = elEmail.value.trim();

    if (!name) problems.push("Full name is required.");
    if (!email) problems.push("Email is required.");
    if (email && !/^\S+@\S+\.\S+$/.test(email)) problems.push("Email format looks invalid.");

    const missing = QUESTIONS.filter(q => q.required && !ANSWERS.has(q.id)).map(q => q.id);
    if (missing.length) problems.push(`Missing required items: ${missing.slice(0,12).join(", ")}${missing.length>12?" …":""}`);

    return problems;
  }

  function buildPayload(){
    const respondent = {
      name: elName.value.trim(),
      email: elEmail.value.trim(),
      organization: elOrg.value.trim()
    };

    const answers = QUESTIONS
      .filter(q => ANSWERS.has(q.id))
      .map(q => ({
        question_id: q.id,
        value: ANSWERS.get(q.id),
        section: q.section,
        weight: q.weight,
        reverse: q.reverse
      }));

    return {
      tool: "LRID™",
      version: META.version || "unknown",
      respondent,
      answers,
      meta: META
    };
  }

  async function submit(){
    hideWarn();
    setStatus("", "");

    const problems = validate();
    if (problems.length){
      showWarn("<strong>Please fix the following:</strong><br/>• " + problems.map(escapeHtml).join("<br/>• "));
      setStatus("Validation failed.", "err");
      return;
    }

    btnSubmit.disabled = true;
    btnReset.disabled = true;
    setStatus("Submitting…", "");

    const payload = buildPayload();

    try{
      const resp = await fetch("/api/intake/submit", {
        method: "POST",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify(payload)
      });

      const out = await resp.json().catch(() => ({}));
      if (!resp.ok || !out || out.ok !== true){
        const msg = out?.error ? String(out.error) : `Submit failed (${resp.status})`;
        throw new Error(msg);
      }

      // ✅ Redirect to thank-you page provided by backend
      if (out.thank_you_url){
        setStatus("Success. Redirecting…", "ok");
        window.location.assign(out.thank_you_url);
        return;
      }

      // Fallback: show inline success
      setStatus("Success. Report generated.", "ok");
      showWarn(`<strong>Success.</strong><br/>Report URL: <a target="_blank" rel="noopener" href="${escapeHtml(out.report_url || "#")}">${escapeHtml(out.report_url || "n/a")}</a>`);
    }catch(e){
      setStatus("Submit failed.", "err");
      showWarn(`<strong>Submit error:</strong><br/>${escapeHtml(e?.message || String(e))}`);
      btnSubmit.disabled = false;
      btnReset.disabled = false;
      return;
    }
  }

  function resetAll(){
    ANSWERS.clear();
    setStatus("", "");
    hideWarn();
    render();
  }

  btnSubmit.addEventListener("click", submit);
  btnReset.addEventListener("click", resetAll);

  async function loadConfig(){
    elCfg.textContent = "loading…";
    elCfg.style.color = "";

    try{
      const r = await fetch(CONFIG_URL, { cache: "no-store" });
      if (!r.ok) throw new Error(`Config fetch failed: HTTP ${r.status}`);
      const raw = await r.json();

      const norm = normalizeConfig(raw);
      QUESTIONS = norm.questions;
      META = {
        title: norm.meta?.title || "LRID™ Assessment",
        version: norm.meta?.version || norm.meta?.ver || "1.0"
      };

      elCfg.textContent = "loaded";
      elCfg.style.color = "var(--ok)";

      render();
      setStatus("", "");
    }catch(e){
      elCfg.textContent = "error";
      elCfg.style.color = "var(--danger)";

      elIntro.textContent = "Config could not be loaded. The assessment cannot run.";
      showWarn(
        `<strong>Config load failed.</strong><br/>
         URL: <span class="mono">${escapeHtml(CONFIG_URL)}</span><br/>
         Error: ${escapeHtml(e?.message || String(e))}<br/><br/>
         Open diagnostics:<br/>
         • <a href="/api/health" target="_blank" rel="noopener">/api/health</a><br/>
         • <a href="${CONFIG_URL}" target="_blank" rel="noopener">${CONFIG_URL}</a>`
      );
      setStatus("Config error.", "err");
      updateProgress();
    }
  }

  loadConfig();
})();
</script>
</body>
</html>
